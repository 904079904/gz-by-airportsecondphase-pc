var si={buf:{syId:0,createSyId:function(){return this.syId++}}};si.buf.InvokeInfo=function(e,a,b){this.clsName=e;this.methodName=a;this.params=b;this.synId=si.buf.createSyId()+""};
si.buf.Types={Type_Null:0,Type_False:1,Type_True:2,Type_Integer:3,Type_Long:4,Type_Float:5,Type_Double:6,Type_String:7,Type_ObjectArray:8,Type_ByteArray:9,Type_ShortArray:10,Type_Int32Array:11,Type_Int64Array:12,Type_FloatArray:13,Type_DoubleArray:14,Type_Map:15,EMPTY_STRING:"",UINT29_MASK:536870911,INT28_MAX_VALUE:268435455,INT28_MIN_VALUE:-268435456};
si.buf.Out=function(){for(var e in si.buf.Types)this[e]=si.buf.Types[e];this.dv=null;this.out=new si.buf.OutBuffer;this.reset=function(){this.stringTable=[];this.out=new si.buf.OutBuffer;this.p=0};this.write=function(a){this.reset();this.writeObject(a);return this.buffer()};this.writeObject=function(a){if(null==a)this.out.addInt8(this.Type_Null);else if("number"==typeof a)~~a==a?this.writeInt(a):this.writeDouble(a);else if("boolean"==typeof a)this.writeBoolean(a);else if("string"==typeof a)this.writeString(a);
else{var b=Object.prototype.toString.call(a);"[object Array]"==b?this.writeArray(a):"[object Date]"!=b&&("[object ArrayBuffer]"==b?this.writeByteArray(a):this.writeMap(a))}};this.buffer=function(){return this.out.buffer()};this.writeInt=function(a){a>=this.INT28_MIN_VALUE&&a<=this.INT28_MAX_VALUE?(a&=this.UINT29_MASK,this.out.addInt8(this.Type_Integer),this.writeUInt29(a)):this.writeDouble(a)};this.writeUInt29=function(a){if(128>a)this.out.addInt8(a);else if(16384>a)this.out.addInt8(a>>7&127|128),
this.out.addInt8(a&127);else if(2097152>a)this.out.addInt8(a>>14&127|128),this.out.addInt8(a>>7&127|128),this.out.addInt8(a&127);else if(1073741824>a)this.out.addInt8(a>>22&127|128),this.out.addInt8(a>>15&127|128),this.out.addInt8(a>>8&127|128),this.out.addInt8(a&255);else throw"Integer out of range: "+a;};this.writeDouble=function(a){this.out.addInt8(this.Type_Double);this.out.addDouble(a)};this.writeBoolean=function(a){a?this.out.addInt8(this.Type_True):this.out.addInt8(this.Type_False)};this.writeString=
function(a){this.out.addInt8(this.Type_String);this.writeStringWithoutType(a)};this.writeStringWithoutType=function(a){0==a.length?this.writeUInt29(1):this.byReference(a)||this.writeUTF(a)};this.byReference=function(a){if("string"==typeof a)var b=this.stringTable;else return!1;for(var d=b.length,c=null,k=-1,e=0;e<d;++e)if(a==b[e]){c=b[e];k=e;break}null!=c?this.writeUInt29(k<<1):b[b.length]=a;return null!=c};this.writeUTF=function(a){for(var b=0,d=0;d<a.length;d++){var c=a.charCodeAt(d);if(0<=c&&127>=
c)b+=1;else if(128<=c&&2047>=c)b+=2;else if(2048<=c&&55295>=c||57344<=c&&65535>=c)b+=3}d=new ArrayBuffer(b);var e=new Uint8Array(d),f=0;for(d=0;d<a.length;d++)if(c=a.charCodeAt(d),0<=c&&127>=c)e[f++]=c;else if(128<=c&&2047>=c)b+=2,e[f++]=192|31&c>>6,e[f++]=128|63&c;else if(2048<=c&&55295>=c||57344<=c&&65535>=c)b+=3,e[f++]=224|15&c>>12,e[f++]=128|63&c>>6,e[f++]=128|63&c;a=e.buffer;this.writeUInt29(a.byteLength<<1|1);this.out.addArrayBuffer(a)};this.writeArray=function(a){this.out.addInt8(this.Type_ObjectArray);
this.writeUInt29(a.length<<1|1);for(var b=0;b<a.length;++b)this.writeObject(a[b])};this.writeDate=function(a){this.out.addInt8(this.Type_Date);this.byReference(a)||(this.writeUInt29(1),this.out.addDouble(a.getTime()))};this.writeByteArray=function(a){this.out.addInt8(this.Type_ByteArray);this.writeUInt29(a.byteLength<<1|1);this.out.addArrayBuffer(a)};this.writeMap=function(a){this.out.addInt8(this.Type_Map);var b=[],d="",c;for(c in a)b.push(c);for(c=0;c<b.length;++c)d+=b[c],c<b.length-1&&(d+="@\n");
this.byReference(d)||this.writeUTF(d);for(c=0;c<b.length;++c)this.writeObject(a[b[c]])}};
si.buf.In=function(){for(var e in si.buf.Types)this[e]=si.buf.Types[e];this.dv=null;this.reset=function(){this.objectTable=[];this.p=0};this.read=function(a){this.dv=new DataView(a);this.reset();a=this.dv.getInt8(this.p++,!0);return this.readObjectValue(a)};this.readObject=function(){var a=this.dv.getInt8(this.p++,!0);return this.readObjectValue(a)};this.readObjectValue=function(a){var b=null;switch(a){case this.Type_ObjectArray:b=this.readObjectArray();break;case this.Type_Map:b=this.readObjectMap();
break;case this.Type_String:b=this.readString();break;case this.Type_Float:b=this.readFloat32();break;case this.Type_Double:b=this.readFloat64();break;case this.Type_FloatArray:b=this.readFloatArray();break;case this.Type_ShortArray:b=this.readUint16Array();break;case this.Type_ByteArray:b=this.readByteArray();break;case this.Type_False:b=!1;break;case this.Type_True:b=!0;break;case this.Type_Integer:b=this.readUInt29()<<3>>3;break;case this.Type_Null:break;default:throw"UnKnowTypeException:"+a;}return b};
this.readObjectArray=function(){var a=this.readUInt29();if(0==(a&1))return this.getObjectReference(a>>1);a>>=1;for(var b=[],d=0;d<a;d++){var c=this.dv.getInt8(this.p++,!0);c=this.readObjectValue(c);b[d]=c}return b};this.readString=function(){var a=this.readUInt29();if(0==(a&1))return this.getObjectReference(a>>1);a>>=1;if(0==a)return"";a=this.readUTF(a);this.objectTable.push(a);return a};this.readObjectMap=function(){var a=this.readUInt29();if(0==(a&1))a=this.getObjectReference(a>>1);else{a>>=1;if(0==
a)return"";a=this.readUTF(a);this.objectTable.push(a)}var b=a.split("@\n");a=b.length;for(var d={},c=0;c<a;++c){var e=b[c];try{d[e]=this.readObject()}catch(f){}}return d};this.readFloatArray=function(){var a=this.readUInt29();if(0==(a&1))return this.objectTable[a>>1];a=4*(a>>1);var b=this.p;b=new Float32Array(this.dv.buffer.slice(b,b+a));this.p+=a;return b};this.readUint16Array=function(){var a=this.readUInt29();if(0==(a&1))return this.objectTable[a>>1];a=2*(a>>1);var b=this.p;b=new Uint16Array(this.dv.buffer.slice(b,
b+a));this.p+=a;return b};this.readByteArray=function(){var a=this.readUInt29();if(0==(a&1))return this.getObjectReference(a>>1);a>>=1;var b=this.p;b=this.dv.buffer.slice(b,b+a);this.p+=a;return b};this.readUTF=function(a){for(var b,d=[],c=0;c<a;c++)d.push(this.dv.getUint8(this.p+c));b="";var e;for(c=0;c<d.length;c++){var f=d[c].toString(2);if((e=f.match(/^1+?(?=0)/))&&8==f.length){e=e[0].length;f=d[c].toString(2).slice(7-e);for(var g=1;g<e;g++)f+=d[g+c].toString(2).slice(2);b+=String.fromCharCode(parseInt(f,
2));c+=e-1}else b+=String.fromCharCode(d[c])}this.p+=a;return b};this.readUInt29=function(){var a=this.dv.getUint8(this.p++);if(128>a)return a;var b=(a&127)<<7;a=this.dv.getUint8(this.p++);if(128>a)return b|a;b=(b|a&127)<<7;a=this.dv.getUint8(this.p++);if(128>a)return b|a;b=(b|a&127)<<8;a=this.dv.getUint8(this.p++);return b|a};this.readFloat32=function(){var a=this.dv.getFloat32(this.p,!0);this.p+=4;return a};this.readFloat64=function(){var a=this.dv.getFloat64(this.p,!0);this.p+=8;return a};this.getObjectReference=
function(a){return this.objectTable[a]}};
si.buf.OutBuffer=function(){this.buf=new ArrayBuffer(32);this.dv=new DataView(this.buf);this.p=0;this.ensureCapacity=function(e){0<e-this.buf.byteLength&&this.grow(e)};this.grow=function(e){var a=this.buf.byteLength,b=a<<1;0>b-e&&(b=e);e=new ArrayBuffer(b);b=new DataView(e);for(var d=0;d<a;++d)b.setInt8(d,this.dv.getInt8(d));this.buf=e;this.dv=b};this.addInt8=function(e){this.ensureCapacity(this.p+1);this.dv.setInt8(this.p++,e);this.log()};this.addDouble=function(e){this.ensureCapacity(this.p+8);
this.dv.setFloat64(this.p,e,!0);this.p+=8;this.log()};this.addArrayBuffer=function(e){var a=e.byteLength;e=new Int8Array(e);this.ensureCapacity(this.p+a);for(var b=0;b<a;++b)this.dv.setInt8(this.p+b,e[b]);this.p+=a;this.log()};this.reset=function(){this.p=0};this.buffer=function(){for(var e=new Int8Array(this.p),a=0;a<this.p;++a)e[a]=this.dv.getInt8(a);return e.buffer};this.log=function(){};this.size=function(){return this.p}};
var ServConn=function(e,a,b){this.url=e;this.callbacks={};this.lis={};this.login_info=a;this.status=0;this.ws=null;this.out=new si.buf.Out;this.appid=b;this.connect=function(){this.close();var d=this;si.buf.conn=d;null!=d.ws&&d.ws.close();d.ws=new WebSocket(d.url);d.ws.binaryType="arraybuffer";d.status=0;this.ws.onmessage=function(a){d.status=1;this.time=Date.now();var b=new si.buf.In;a=b.read(a.data);a={type:a[0],from:a[1],to:a[2],data:a[3]};"[object ArrayBuffer]"==Object.prototype.toString.call(a.data)&&
(a.data=b.read(a.data));d.fire(a.type,a)};this.ws.onopen=function(c){this.time=Date.now();c=d.out.write([0,b,"server",a]);d.ws.send(c)};this.ws.onerror=function(a){1==d.status?d.connect():(d.status=0,d.parent&&(d.parent._conn=null));d.fire(si.buf.Evt_IO_Error,a)};this.ws.onclose=function(a){1==d.status?d.connect():(d.status=0,d.parent&&(d.parent._conn=null));d.fire(si.buf.Evt_IO_Close,a)}};this.call=function(a,b,e){this.status&&(a=this.out.write([a,this.appid,b,e]),this.ws.send(a))};this.fire=function(a,
b){var c=this.lis[a];if(c)for(var d=0;d<c.length;++d){var e=c[d];try{e(b,a)}catch(h){}}};this.close=function(){null!=this.ws&&this.ws.close()};this.on=function(a,b){var c=this.lis[a];c||(c=[],this.lis[a]=c);c.push(b)};this.remove=function(a,b){var c=this.lis[a];if(c){for(var d=[],e=0;e<c.length;++e){var h=c[e];h!=b&&(d[d.length]=h)}this.lis[a]=d}}},globalChannel=ServConn;window.VexChannel=globalChannel;globalChannel.connect=ServConn.connect;globalChannel.call=ServConn.call;globalChannel.fire=ServConn.fire;
globalChannel.on=ServConn.on;globalChannel.remove=ServConn.remove;globalChannel.close=ServConn.close;globalChannel.decode=function(e){return(new si.buf.In).read(e)};
